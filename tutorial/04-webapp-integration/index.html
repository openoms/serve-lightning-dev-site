<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Stage 4 - Webapp Integration</title>
  <meta name="description" content="Developer resources and documentation for the Lightning Network Daemon.">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="/assets/dropdown.css">
  <link rel="canonical" href="http://0.0.0.0:4000/tutorial/04-webapp-integration/">
  <link rel="alternate" type="application/rss+xml" title="Lightning Network Developers" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Lightning Network Developers</a>

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          <div class="dropdown">
            <a class="page-link" href="/guides"><button class="dropbtn">Guides</button></a>
            <div class="dropdown-content">
              <a href="/overview/">Overview</a>
              <a href="/guides/installation/">Installation</a>
              <a href="/tutorial/">Tutorial</a>
              <a href="/guides/python-grpc/">Python</a>
              <a href="/guides/javascript-grpc/">Javascript</a>
              <a href="/guides/docker/">Docker</a>
            </div>
          </div>
          <a class="page-link" href="//api.lightning.community">API</a>
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Stage 4 - Webapp Integration</h1>
  </header>

  <div class="post-content">
    <p>In this stage, we will integrate Lightning micropayments into our server-side
web application.</p>

<h3 id="starting-afresh">Starting Afresh</h3>

<p>It’s time to recreate the micropayments ourselves. Get the starter code:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Clear any local changes first and checkout the start tag</span>
git checkout <span class="nt">--</span> <span class="nb">.</span>
git checkout start
</code></pre></div></div>

<p>The starter code has stripped out all micropayments code, and we just also just
reset our database state to the default.</p>

<h3 id="the-models">The models</h3>

<p>First, let’s examine <code class="highlighter-rouge">coindesk/models.py</code> to understand our web app a little
better.</p>

<p><code class="highlighter-rouge">coindesk/models.py</code> (cleaned up a little bit):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">modified_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">identity_pubkey</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c1"># bitcoin_address = BitcoinAddressField()
</span>

<span class="k">class</span> <span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">ARTICLE_STATUS_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'visible'</span><span class="p">,</span> <span class="s">'Visible'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'deleted by admin'</span><span class="p">,</span> <span class="s">'Deleted by admin'</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">191</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'visible'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">ARTICLE_STATUS_CHOICES</span><span class="p">)</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">views</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">'complete'</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s">'view'</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Payment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="n">PAYMENT_STATUS_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'pending_invoice'</span><span class="p">,</span> <span class="s">'Pending Invoice'</span><span class="p">),</span> <span class="c1"># Should be atomic
</span>        <span class="p">(</span><span class="s">'pending_payment'</span><span class="p">,</span> <span class="s">'Pending Payment'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'complete'</span><span class="p">,</span> <span class="s">'Complete'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'error'</span><span class="p">,</span> <span class="s">'Error'</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">PAYMENT_PURPOSE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'view'</span><span class="p">,</span> <span class="s">'View'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'upvote'</span><span class="p">,</span> <span class="s">'Upvote'</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Article</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">'payments'</span><span class="p">)</span>
    <span class="n">purpose</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">PAYMENT_PURPOSE_CHOICES</span><span class="p">)</span>

    <span class="n">satoshi_amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">r_hash</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">payment_request</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'pending_invoice'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">PAYMENT_STATUS_CHOICES</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">modified_at</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">article</span><span class="p">):</span>
        <span class="s">"""
        Generates a new invoice
        """</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">check_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">"""
        Checks if the Lightning payment has been received for this invoice
        """</span>
        <span class="k">pass</span>
</code></pre></div></div>

<p>Each <code class="highlighter-rouge">Profile</code> object is associated with one <code class="highlighter-rouge">User</code> object, and stores the
identity pubkey of that user.</p>

<p>The <code class="highlighter-rouge">Article</code> class has a title, text, a timestamp and some basic moderation
functionality. Notice that the number of views for an article as counted as the
number of completed payments associated with it.</p>

<p>The <code class="highlighter-rouge">Payment</code> class represents a Lightning micropayment, and is going to be
where we implement the bulk of our work. Each payment is associated with a particular user and a article.</p>

<p>We have the <code class="highlighter-rouge">satoshi_amount</code>, <code class="highlighter-rouge">r_hash</code> and <code class="highlighter-rouge">payment_request</code> fields - the basic technical information
required to conduct a Lightning payment.</p>

<p>Each <code class="highlighter-rouge">Payment</code> goes through the
following lifecycle, represented by the <code class="highlighter-rouge">status</code> field:</p>

<ol>
  <li>The payment is initially pending an invoice. Calling <code class="highlighter-rouge">generate_invoice</code> will
generate an invoice for a user and a particular article they want to view.</li>
  <li>After the invoice is generated, it is now pending payment.</li>
  <li><code class="highlighter-rouge">check_payment</code> will check if a payment has indeed been received by Bob
node. Afterwards, this <code class="highlighter-rouge">Payment</code> counts as complete, and the user should be
able to view the article.</li>
</ol>

<p>It will soon be up to us to implement the <code class="highlighter-rouge">generate_invoice</code> and
<code class="highlighter-rouge">check_payment</code> functions. But first, let’s add in some security.</p>

<h3 id="the-views">The views</h3>

<p>We also need to understand some of the wiring behind the app.</p>

<p>Open <code class="highlighter-rouge">coindesk/views.py</code>. For our purposes, the <code class="highlighter-rouge">article</code> view is the most
important since it is executed when we view an article and handles what to do
with the different payment states.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">article</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">'visible'</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Article</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"Article with id {} does not exist or is not visible"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'article'</span><span class="p">:</span> <span class="n">article</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
            <span class="n">template_name</span><span class="o">=</span><span class="s">'article.html'</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

    <span class="n">qs</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s">'view'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Generate a new payment
</span>        <span class="n">payment</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Payment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
                          <span class="n">article</span><span class="o">=</span><span class="n">article</span><span class="p">,</span>
                          <span class="n">purpose</span><span class="o">=</span><span class="s">'view'</span><span class="p">,</span>
                          <span class="n">satoshi_amount</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MIN_VIEW_AMOUNT</span><span class="p">,</span>
                          <span class="n">status</span><span class="o">=</span><span class="s">'pending_invoice'</span><span class="p">)</span>
        <span class="n">payment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">payment</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This should not happen because there should never be more than one view payment per article per person
</span>        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"Multiple payments detected"</span><span class="p">)</span>

    <span class="c1"># User client requests that we check if the payment has been made
</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'check'</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"Checking for payment {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">payment_request</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">payment</span><span class="o">.</span><span class="n">check_payment</span><span class="p">():</span>
            <span class="k">print</span> <span class="s">"Payment succeeded!"</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">"Payment not received"</span>

    <span class="k">if</span> <span class="n">payment</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'pending_invoice'</span><span class="p">:</span>
        <span class="n">payment</span><span class="o">.</span><span class="n">generate_invoice</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">article</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">payment</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'pending_payment'</span><span class="p">:</span>
        <span class="c1"># Do nothing; display the payment page to user
</span>        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">payment</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'complete'</span><span class="p">:</span>
        <span class="c1"># Do nothing; display the article to user
</span>        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">payment</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'error'</span><span class="p">:</span>
        <span class="c1"># TODO Optionally implement some kind of error resolution
</span>        <span class="k">pass</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">"Payment error"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span><span class="p">[</span><span class="s">'payment_status'</span><span class="p">]</span> <span class="o">=</span> <span class="n">payment</span><span class="o">.</span><span class="n">status</span>

    <span class="n">context</span><span class="p">[</span><span class="s">'payment'</span><span class="p">]</span> <span class="o">=</span> <span class="n">payment</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
        <span class="n">template_name</span><span class="o">=</span><span class="s">'article.html'</span><span class="p">,</span>
        <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<p>A quick breakdown of what’s going on:</p>
<ol>
  <li>First, we try to find the appropriate <code class="highlighter-rouge">Article</code> by its id. If successful, we
populate the <code class="highlighter-rouge">context</code> variable so that the template can work with it.</li>
  <li>If the user is not logged in, we can’t check for a payment from them because
we don’t know who they are, so we just direct them to the article page.</li>
  <li>We attempt to find a <code class="highlighter-rouge">Payment</code> for this particular <code class="highlighter-rouge">User</code> and <code class="highlighter-rouge">Article</code>. If
a <code class="highlighter-rouge">Payment</code> was not found, we generate a new one. The satoshi amount is set
by <code class="highlighter-rouge">settings.MIN_VIEW_AMOUNT</code>, which defaults to 1000 satoshis.  This newly
created <code class="highlighter-rouge">Payment</code> has the initial state: <code class="highlighter-rouge">pending_invoice</code>.</li>
  <li>If the user provides the <code class="highlighter-rouge">check</code> query parameter, we call the
<code class="highlighter-rouge">check_payment</code> function, which will check if the payment was indeed
complete and update the state if so.</li>
  <li>If the payment is pending an invoice, we call the <code class="highlighter-rouge">generate_invoice</code>
function, which will generate the invoice and update the Payment state.</li>
  <li>If the payment is in any other state, we render <code class="highlighter-rouge">article.html</code> for the user
or throw an error.</li>
</ol>

<h3 id="adding-in-a-paywall">Adding in a paywall</h3>

<p>Right now, all the articles in the app are freely viewable. We all know no one
likes free stuff, so let’s fix that.</p>

<p>We will begin by adding some conditionals in the html where we are currently
displaying the article content.</p>

<p>In <code class="highlighter-rouge">coindesk/templates/article.html</code>, notice the following code:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"article-body"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"article-text"</span><span class="nt">&gt;</span>
    {{ article.text }}
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">{{ article.text }}</code> is the Django template variable
representing the text of the website. We need to hide this for all
non-authenticated users. Let’s show them the <code class="highlighter-rouge">pay.html</code> page instead. And of
course, users who have completed payments must be able to view the article
text.</p>

<p>Make the necessary edits:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"article-body"</span><span class="nt">&gt;</span>
  {% if not request.user.is_authenticated %}
    <span class="nt">&lt;h3&gt;</span>Make Payment<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;p&gt;</span>
      To view this article, please log in and return to this page to make
      a payment.
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"complete_button"</span> <span class="na">href=</span><span class="s">"/login"</span><span class="nt">&gt;</span>Log in<span class="nt">&lt;/a&gt;</span>
  {% elif payment.status == "complete" %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"article-text"</span><span class="nt">&gt;</span>
      {{ article.text }}
    <span class="nt">&lt;/div&gt;</span>
  {% else %}
    <span class="nt">&lt;div&gt;</span>
      {% include "pay.html" %}
    <span class="nt">&lt;/div&gt;</span>
  {% endif %}
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>As this is a Lightning tutorial, understanding the exact syntax is not
important, but a quick clarification may be helpful:</p>
<ul>
  <li>The <code class="highlighter-rouge">{% if %}</code> blocks are Django’s way of adding
conditionals in html templates. We are using this to determine if users are
logged in or if the payment is complete.</li>
  <li><code class="highlighter-rouge">payment</code> is a context variable the template needs populated in order to
render correctly and access the relevant information. This was done in the
<code class="highlighter-rouge">article</code> view.</li>
  <li>The <code class="highlighter-rouge">{% include %}</code> tag adds in the template by the name
of <code class="highlighter-rouge">pay.html</code>.</li>
</ul>

<p>We should now see something like this when we click on an article:
<img src="http://i.imgur.com/bVc4M06.png" alt="logged out article page" /></p>

<h3 id="generating-an-invoice">Generating an invoice</h3>

<p>Examine <code class="highlighter-rouge">coindesk/templates/pay.html</code>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"payment"</span> <span class="na">class=</span><span class="s">"ln-dialog"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"submit_box"</span> <span class="na">class=</span><span class="s">"animated fadeInDown delay"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Make Payment<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;p&gt;</span>To view this article, please pay 1000 satoshis via the request below:<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"small"</span><span class="nt">&gt;</span>{{ payment.payment_request }}<span class="nt">&lt;/p&gt;&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"complete_button"</span> <span class="na">href=</span><span class="s">"/articles/{{ article.id }}/?check=true"</span><span class="nt">&gt;</span>Complete<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>This template prompts the user to pay 1000 satoshis, and supplies a payment
request.</p>

<p>Log in as Alice. The page should look something like this:
<img src="http://i.imgur.com/FpyjezK.png" alt="logged in article page with payment prompt missing payment
request" /></p>

<p>We are missing the payment request, so let’s generate an invoice.</p>

<p>Navigate to <code class="highlighter-rouge">generate_invoice</code> in <code class="highlighter-rouge">coindesk/models.py</code>. Modify it to the
following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">generate_invoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">article</span><span class="p">):</span>
    <span class="s">"""
    Generates a new invoice
    """</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'pending_invoice'</span><span class="p">,</span> <span class="s">"Already generated invoice"</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LND_RPCHOST</span><span class="p">)</span>
    <span class="n">stub</span> <span class="o">=</span> <span class="n">lnrpc</span><span class="o">.</span><span class="n">LightningStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

    <span class="n">add_invoice_resp</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">AddInvoice</span><span class="p">(</span><span class="n">ln</span><span class="o">.</span><span class="n">Invoice</span><span class="p">(</span><span class="n">amt</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MIN_VIEW_AMOUNT</span><span class="p">,</span> <span class="n">memo</span><span class="o">=</span><span class="s">"User '{}' | ArticleId {}"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="nb">id</span><span class="p">)))</span>
    <span class="n">r_hash_base64</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">add_invoice_resp</span><span class="o">.</span><span class="n">r_hash</span><span class="p">,</span> <span class="s">'base64'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">r_hash</span> <span class="o">=</span> <span class="n">r_hash_base64</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">payment_request</span> <span class="o">=</span> <span class="n">add_invoice_resp</span><span class="o">.</span><span class="n">payment_request</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'pending_payment'</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>Don’t forget also to include the necessary imports at the top of the file:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">coindesk</span> <span class="kn">import</span> <span class="n">rpc_pb2</span> <span class="k">as</span> <span class="n">ln</span><span class="p">,</span> <span class="n">rpc_pb2_grpc</span> <span class="k">as</span> <span class="n">lnrpc</span>
<span class="kn">import</span> <span class="nn">grpc</span>
</code></pre></div></div>

<p>Walking through the code:</p>
<ul>
  <li>We first check that this <code class="highlighter-rouge">Payment</code> is indeed pending an invoice, and throw an
error otherwise.</li>
  <li>Using gRPC, we add an invoice of the amount set by <code class="highlighter-rouge">MIN_VIEW_AMOUNT</code> in
<code class="highlighter-rouge">settings.py</code>.</li>
  <li>We set the <code class="highlighter-rouge">r_hash</code> and <code class="highlighter-rouge">payment_request</code> attributes and update the state of
this <code class="highlighter-rouge">Payment</code> to now be pending payment.</li>
</ul>

<h3 id="checking-for-payment-receipt">Checking for payment receipt</h3>

<p>The last piece needed for our fully functional Lightning Coindesk is to
implement the <code class="highlighter-rouge">check_payment</code> function of the <code class="highlighter-rouge">Payment</code> class. Recall from
<code class="highlighter-rouge">coindesk.views.</code> that <code class="highlighter-rouge">check_payment()</code> is called if the user passes along the
<code class="highlighter-rouge">check</code> query parameter. For your convenience, we have already implemented this
for you in the frontend:</p>

<p>In <code class="highlighter-rouge">coindesk/templates/pay.html</code>:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">id=</span><span class="s">"complete_button"</span> <span class="na">href=</span><span class="s">"/articles//?check=true"</span><span class="nt">&gt;</span>Complete<span class="nt">&lt;/a&gt;</span>
</code></pre></div></div>

<p>Now, try to implement the <code class="highlighter-rouge">check_payment</code> function yourself. Here’s some
starter code to help you with the annoying and unimportant parts:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">check_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s">"""
    Checks if the Lightning payment has been received for this invoice
    """</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'pending_invoice'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c1"># Prepare r_hash_bytes, which can be passed into the gRPC client
</span>    <span class="n">r_hash_base64</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
    <span class="n">r_hash_bytes</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">r_hash_base64</span><span class="p">,</span> <span class="s">'base64'</span><span class="p">))</span>

    <span class="c1"># Implement this
</span>    <span class="n">payment_settled</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">payment_settled</span><span class="p">:</span>
        <span class="c1"># Payment complete
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'complete'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Payment not received
</span>        <span class="k">return</span> <span class="bp">False</span>
</code></pre></div></div>

<p>If you’re absolutely stuck, you may refer to the <a href="https://github.com/MaxFangX/lightning-coindesk">tutorial
repo</a> for the final solution.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Congratulations! You have now built a working Lightning Coindesk app! If you
are looking to take this tutorial to the next level, consider trying one or
more of the following:</p>

<ul>
  <li>Integrate error handling in the webapp; see the TODO in
<code class="highlighter-rouge">coindesk.views.article</code></li>
  <li>Add P2P payments through the app. Instead of paying the central server,
distribute your micropayment equally between all the people who upvoted
before you. The upvote functionality was intentionally left unimplemented for
this purpose.</li>
  <li>Run this application in a more “production” environment, by using <code class="highlighter-rouge">testnet</code>
and deploying your webapp online</li>
  <li>Allow the server to accept Litecoin in addition to Bitcoin.</li>
</ul>

<p>At this point, you’re ready to build with <code class="highlighter-rouge">lnd</code>. Go forth and bring
Bitcoin to the masses!</p>

<h4 id="next-steps">Next Steps</h4>

<p>Read through the <a href="/overview/">LND Overview and Developer Guide</a> to see best
practices and guidelines for implementing LND in your own webapp, or for a
conceptual brushup of the Lightning Network.</p>

<p>Check out the accessible dev manuals available on our <a href="/guides/">Guides page</a>.</p>

<h4 id="navigation">Navigation</h4>
<ul>
  <li><a href="/tutorial/03-rpc-client">Return to Stage 3 - RPC Client</a></li>
  <li><a href="/tutorial/">Return to main tutorial page</a></li>
</ul>

<h3 id="questions">Questions</h3>
<ul>
  <li>Join the #dev-help channel on our <a href="https://join.slack.com/t/lightningcommunity/shared_invite/enQtMzQ0OTQyNjE5NjU1LWRiMGNmOTZiNzU0MTVmYzc1ZGFkZTUyNzUwOGJjMjYwNWRkNWQzZWE3MTkwZjdjZGE5ZGNiNGVkMzI2MDU4ZTE">Community
Slack</a></li>
  <li>Join IRC:
<a href="https://webchat.freenode.net/?channels=lnd"><img src="https://img.shields.io/badge/chat-on%20freenode-brightgreen.svg" alt="Irc" /></a></li>
</ul>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Lightning Network Developers</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Max Fang
            
            </li>
            
            <li>
              <a href="mailto:max@lightning.engineering">
                <span>max@lightning.engineering</span>
              </a>
            </li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/lightningnetwork/lnd"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">lnd</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/lightning"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">lightning</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Developer resources and documentation for the Lightning Network Daemon.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
